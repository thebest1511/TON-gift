import asyncio
import aiohttp
from telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode

# === –¢–í–û–ò –î–ê–ù–ù–´–ï ===
BOT_TOKEN = "7729327720:AAGlx0TNABjMPDFZMz01YAKDhfd_ZSTRB1g"  # —Ç–≤–æ–π —Ç–æ–∫–µ–Ω
MY_CHAT_ID = 1957724574  # —Ç–≤–æ–π –ª–∏—á–Ω—ã–π ID

WEB_APP_URL = "https://thebest1511.github.io/TON-gift/"  # —Ç–≤–æ—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

MIN_PRICE = 0
MAX_PRICE = 100
# ===================

bot = Bot(token=BOT_TOKEN)

async def send_message(text, photo_url=None):
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={"url": WEB_APP_URL})]
    ])

    try:
        if photo_url:
            async with aiohttp.ClientSession() as session:
                async with session.get(photo_url) as resp:
                    if resp.status == 200:
                        photo_data = await resp.read()
                        await bot.send_photo(chat_id=MY_CHAT_ID, photo=photo_data, caption=text, parse_mode=ParseMode.HTML, reply_markup=keyboard)
                        return
        await bot.send_message(chat_id=MY_CHAT_ID, text=text, parse_mode=ParseMode.HTML, reply_markup=keyboard)
    except Exception as e:
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
        print("–í–æ–∑–º–æ–∂–Ω–æ, —Ç—ã –Ω–µ –Ω–∞–ø–∏—Å–∞–ª –±–æ—Ç—É –ø–µ—Ä–≤—ã–º. –ù–∞–ø–∏—à–∏ –µ–º—É /start –∏–ª–∏ '–ø—Ä–∏–≤–µ—Ç' –≤ Telegram.")

async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ñ–¥—ë–º –Ω–æ–≤—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ –ø–æ–¥–∞—Ä–∫–æ–≤...")

    # –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø—Ä–∏–¥—ë—Ç –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã –Ω–∞–ø–∏—à–µ—à—å –±–æ—Ç—É)
    await send_message("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!\n\n–Ø –ø—Ä–∏—Å—ã–ª–∞—é –Ω–æ–≤—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–æ 100 TON.\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ üëá")

    processed = set()

    while True:
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get("https://tonapi.io/v2/events?limit=50") as resp:
                    if resp.status != 200:
                        await asyncio.sleep(15)
                        continue
                    data = await resp.json()
                    events = data.get("events", [])

            for event in events:
                event_id = event.get("id")
                if event_id in processed:
                    continue

                actions = event.get("actions", [])
                if not actions:
                    continue
                action = actions[0]
                if action.get("type") != "NftItemSalePlace":
                    continue

                sale = action.get("NftItemSalePlace", {})
                nft_address = sale.get("nft")
                price_value = sale.get("price", {}).get("value", 0)
                if not nft_address or not price_value:
                    continue

                price = int(price_value) / 1_000_000_000
                if not (MIN_PRICE <= price <= MAX_PRICE):
                    continue

                async with aiohttp.ClientSession() as session:
                    async with session.get(f"https://tonapi.io/v2/nfts/{nft_address}") as nft_resp:
                        if nft_resp.status != 200:
                            continue
                        nft = await nft_resp.json()

                metadata = nft.get("metadata", {})
                name = metadata.get("name", "Gift").strip()
                collection = nft.get("collection", {})
                collection_name = collection.get("name", "Unknown").strip()

                previews = nft.get("previews", [])
                photo_url = next((p.get("url") for p in reversed(previews) if p.get("url")), None)

                collection_addr = collection.get("address")
                floor = "‚Äî"
                if collection_addr:
                    async with aiohttp.ClientSession() as session:
                        async with session.get(f"https://tonapi.io/v2/nft/collections/{collection_addr}/floor_price") as floor_resp:
                            if floor_resp.status == 200:
                                floor_data = await floor_resp.json()
                                floor_val = floor_data.get("floor_price")
                                if floor_val:
                                    floor = f"{int(floor_val)/1_000_000_000:.2f}"

                marketplace = "Unknown"
                sale_str = str(sale).lower()
                if "getgems" in sale_str:
                    marketplace = "GetGems"
                elif "tonnel" in sale_str:
                    marketplace = "Tonnel"
                elif "mrkt" in sale_str:
                    marketplace = "MRKT"
                elif "portals" in sale_str:
                    marketplace = "Portals"

                text = f"""
üî• –ù–æ–≤—ã–π –ª–∏—Å—Ç–∏–Ω–≥!
[{collection_name}]
{name}

üí∞ {price:.2f} TON –Ω–∞ {marketplace}

–§–ª–æ—Ä: {floor} TON

–°—Å—ã–ª–∫–∞: https://getgems.io/nft/{nft_address}
                """.strip()

                await send_message(text, photo_url)
                processed.add(event_id)

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ: {e}")

        await asyncio.sleep(15)

asyncio.run(main())
